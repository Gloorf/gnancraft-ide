<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Editing {{fname}}</title>

    <link rel="stylesheet" type="text/css" href="/static/css/droplet.css">
    <script src="/static/js/jquery.js"></script>
    <script src="/static/js/ace/ace.js" type="text/javascript"></script>
    <script src="/static/js/beautify.js"></script>
    <script src="/static/js/require.js"></script>
    <script src="/static/js/droplet-full.js"></script>
    <script src="/static/js/dropletOptions.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <style>
      body {
        font-family: sans-serif;
        overflow: hidden;
        margin: 0px; padding: 0px;
      }
      #editor {
        position: absolute;
        top: 3em;
        bottom: 0px;
        right: 0px;
        left: 0px;
        background-color: #EEE;
        z-index: 0;
      }
      #toolbar {
        z-index: 9999;
        top: 1.5em;
        position: absolute;
      }
    </style>
  </head>
  <body>
<p><b>Editing {{fname}}</b>
<span id="status">
{% if not can_save %} (not yours) {% else %} (saved) {% endif %}
</span>
- <a href="/edit/">back</a>
<div id="toolbar">
  <input type='button' {% if not can_save %} disabled {% endif %} onclick='submitText()' value='Save'/>
  <input type='button' onclick='clean()' value='Clean'/>
  <input type='button' onclick='dropletEditor.toggleBlocks();' value='Toggle Blocks'/>
</div>
<div id="editor">
</div>

<script type="text/javascript">

function clean() {
  dropletEditor.setValue(js_beautify(dropletEditor.getValue()));
}

function submitText() {
   var txt=editor.getValue();
   jQuery.post("{{save_url}}", { text : txt }, 
      function(data, txtStatus) {
         document.getElementById("status").innerHTML = "(saved)";
      }
   );
}

var dropletEditor, editor;

jQuery(document).ready(function() {
  require(['droplet'],function(droplet){
    dropletEditor = new droplet.Editor(document.getElementById("editor"),dropletOptions);
    dropletEditor.setEditorState(false);
    editor = dropletEditor.aceEditor;
    {% if not can_save %}
    editor.setReadOnly(true);
    {% endif %}
    editor.getSession().setMode("ace/mode/javascript");

    jQuery.get("{{file_url}}", function(content) {
      dropletEditor.setValue(content);
      {% if can_save %}
      dropletEditor.on('change', function(e) {
         document.getElementById("status").innerHTML = "(altered)";
      });
      {% endif %}
    });
  });

});

</script>

  </body>
</html>
